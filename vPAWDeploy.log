2025-06-11 15:48:14 [INFO] Already logged in to Azure CLI as andrew@kemponline.co.uk
2025-06-11 15:48:14 [INFO] Already connected to Az PowerShell as andrew@kemponline.co.uk
2025-06-11 15:48:14 [INFO] Already connected to Microsoft Graph as andrew@kemponline.co.uk
2025-06-11 15:48:14 [INFO] Environment preparation complete.
2025-06-11 15:48:15 [INFO] Fetching Azure subscriptions...
2025-06-11 15:48:20 [INFO] Using subscription: Microsoft Azure Sponsorship (9ccc53d0-c424-42d0-8fd6-b48edcea12dd)
2025-06-11 15:48:22 [INFO] Subscription selection complete.
2025-06-11 15:48:32 [INFO] Using resource group: Kemponline-AVD (uksouth)
2025-06-11 15:48:32 [INFO] Resource group setup complete.
2025-06-11 15:48:43 [INFO] Already logged in to Azure CLI as andrew@kemponline.co.uk
2025-06-11 15:48:43 [INFO] Already connected to Az PowerShell as andrew@kemponline.co.uk
2025-06-11 15:48:43 [INFO] Already connected to Microsoft Graph as andrew@kemponline.co.uk
2025-06-11 15:48:43 [INFO] Environment preparation complete.
2025-06-11 15:48:44 [INFO] Fetching Azure subscriptions...
2025-06-11 15:49:55 [INFO] Using subscription: Microsoft Azure Sponsorship (9ccc53d0-c424-42d0-8fd6-b48edcea12dd)
2025-06-11 15:49:56 [INFO] Subscription selection complete.
2025-06-11 15:51:32 [INFO] Already logged in to Azure CLI as andrew@kemponline.co.uk
2025-06-11 15:51:32 [INFO] Already connected to Az PowerShell as andrew@kemponline.co.uk
2025-06-11 15:51:32 [INFO] Already connected to Microsoft Graph as andrew@kemponline.co.uk
2025-06-11 15:51:32 [INFO] Environment preparation complete.
2025-06-11 15:51:33 [INFO] Fetching Azure subscriptions...
2025-06-11 15:51:37 [INFO] Using subscription: Microsoft Azure Sponsorship (9ccc53d0-c424-42d0-8fd6-b48edcea12dd)
2025-06-11 15:51:40 [INFO] Subscription selection complete.
2025-06-11 15:52:09 [INFO] Creating resource group vPAW in uksouth...
2025-06-11 15:52:12 [INFO] Resource group vPAW created.
2025-06-11 15:52:12 [INFO] Resource group setup complete.
2025-06-11 15:52:21 [INFO] Searching for Azure AD groups containing 'vPAW' for Users (Contributors)...
2025-06-11 15:52:23 [INFO] Selected AAD group for: _Grp-vPAW-Users ObjectId: 12573206-bbc0-498d-b12d-7b5053ea63de
2025-06-11 15:52:23 [INFO] Searching for Azure AD groups containing 'vPAW' for Admins (Elevated Contributors)...
2025-06-11 15:52:25 [INFO] Selected AAD group for: _Grp-vPAW-Admins ObjectId: a6afe79a-4dba-4a5c-9b18-41cee3142b09
2025-06-11 15:52:25 [INFO] Entra group setup complete.
2025-06-11 15:52:35 [INFO] Checking storage account name availability: vpawstorage
2025-06-11 15:52:37 [INFO] Storage account name 'vpawstorage' is available.
2025-06-11 15:52:43 [INFO] All parameters saved for later use in C:\Scripts\GitHub\VirtualPAW\vPAWConf.inf
2025-06-11 15:52:43 [INFO] Deployment parameter input complete.
2025-06-11 15:52:44 [INFO] Deployment parameter summary displayed.
2025-06-11 15:52:56 [INFO] Starting deployment...
2025-06-11 15:52:56 [INFO] az deployment group create --resource-group vPAW --template-file vPAW-CoreInfra.Bicep --parameters DefaultPrefix=vPAW vNetAddressPrefix=192.168.250.0/24 subnetAddressPrefix=192.168.250.0/24 storageAccountName=vpawstorage smbContributorsGroupId=12573206-bbc0-498d-b12d-7b5053ea63de smbElevatedContributorsGroupId=a6afe79a-4dba-4a5c-9b18-41cee3142b09
2025-06-11 15:54:05 [INFO] Deployment command executed.
2025-06-11 15:54:05 [INFO] Deployment section complete.
2025-06-11 15:54:08 [INFO] Assigning 'Virtual Machine User Login' to object 12573206-bbc0-498d-b12d-7b5053ea63de at scope /subscriptions/9ccc53d0-c424-42d0-8fd6-b48edcea12dd/resourceGroups/vPAW...
2025-06-11 15:54:13 [INFO] Assigning 'Virtual Machine User Login' to object a6afe79a-4dba-4a5c-9b18-41cee3142b09 at scope /subscriptions/9ccc53d0-c424-42d0-8fd6-b48edcea12dd/resourceGroups/vPAW...
2025-06-11 15:54:17 [INFO] Assigning 'Virtual Machine Administrator Login' to object a6afe79a-4dba-4a5c-9b18-41cee3142b09 at scope /subscriptions/9ccc53d0-c424-42d0-8fd6-b48edcea12dd/resourceGroups/vPAW...
2025-06-11 15:54:22 [INFO] Assigning 'Desktop Virtualization Power On Contributor' to object 5de3faef-bc6a-4dce-93d6-da682dd1ab99 at scope /subscriptions/9ccc53d0-c424-42d0-8fd6-b48edcea12dd/resourceGroups/vPAW...
2025-06-11 15:54:26 [INFO] Checking for WVD Application Group: vPAW-AppGroup in resource group: vPAW
2025-06-11 15:54:27 [INFO] Assigning 'Desktop Virtualization User' to object 12573206-bbc0-498d-b12d-7b5053ea63de at scope /subscriptions/9ccc53d0-c424-42d0-8fd6-b48edcea12dd/resourcegroups/vPAW/providers/Microsoft.DesktopVirtualization/applicationgroups/vPAW-AppGroup...
2025-06-11 15:54:31 [INFO] Assigning 'Desktop Virtualization User' to object a6afe79a-4dba-4a5c-9b18-41cee3142b09 at scope /subscriptions/9ccc53d0-c424-42d0-8fd6-b48edcea12dd/resourcegroups/vPAW/providers/Microsoft.DesktopVirtualization/applicationgroups/vPAW-AppGroup...
2025-06-11 15:54:34 [INFO] Session Desktop friendly name configuration...
2025-06-11 15:54:55 [INFO] Updating SessionDesktop friendly name to 'Kemponline vPAW'...
2025-06-11 15:54:55 [INFO] RBAC and AVD configuration complete.
2025-06-11 15:54:57 [INFO] Automatically selected storage app: [Storage Account] vpawstorage.file.core.windows.net (AppId: 76cb8750-843f-42e1-976c-1cd4e9d79069)
2025-06-11 15:54:57 [INFO] Storage App selected: [Storage Account] vpawstorage.file.core.windows.net AppId: 76cb8750-843f-42e1-976c-1cd4e9d79069 ObjectId: 05542936-d28b-4169-9ea1-9c330cae1e5b
2025-06-11 15:54:59 [INFO] Conditional Access policies targeting ALL apps (excluding Microsoft Managed) enumerated.
2025-06-11 15:54:59 [INFO] Updating policy '901 - Block Legacy Auth' (Id: a87a3ec0-842e-4b9b-8b43-640842c2fe22) to exclude AppId 76cb8750-843f-42e1-976c-1cd4e9d79069...
2025-06-11 15:55:00 [INFO] Policy '901 - Block Legacy Auth' updated to exclude AppId 76cb8750-843f-42e1-976c-1cd4e9d79069.
2025-06-11 15:55:00 [INFO] Updating policy '101 - MFA For All' (Id: 2b33bee0-e73d-4931-b2f5-a7ab44eba103) to exclude AppId 76cb8750-843f-42e1-976c-1cd4e9d79069...
2025-06-11 15:55:02 [INFO] Policy '101 - MFA For All' updated to exclude AppId 76cb8750-843f-42e1-976c-1cd4e9d79069.
2025-06-11 15:55:02 [INFO] Updating policy '102 - Sign in every day Personal Device' (Id: 0abf4b28-59a0-46fd-b5f8-27fc5082b4e6) to exclude AppId 76cb8750-843f-42e1-976c-1cd4e9d79069...
2025-06-11 15:55:06 [INFO] Policy '102 - Sign in every day Personal Device' updated to exclude AppId 76cb8750-843f-42e1-976c-1cd4e9d79069.
2025-06-11 15:55:06 [INFO] Updating policy '803 - Admin re-authenticate every 8Hrs' (Id: bcea941e-41d4-48b1-b551-913d4175c25a) to exclude AppId 76cb8750-843f-42e1-976c-1cd4e9d79069...
2025-06-11 15:55:08 [INFO] Policy '803 - Admin re-authenticate every 8Hrs' updated to exclude AppId 76cb8750-843f-42e1-976c-1cd4e9d79069.
2025-06-11 15:55:08 [INFO] Updating policy '101 - Passkey' (Id: 24765ef4-7357-4cd5-858b-007bd470a0bb) to exclude AppId 76cb8750-843f-42e1-976c-1cd4e9d79069...
2025-06-11 15:55:09 [INFO] Policy '101 - Passkey' updated to exclude AppId 76cb8750-843f-42e1-976c-1cd4e9d79069.
2025-06-11 15:55:09 [INFO] Updating policy '901 - Privileged Access (New)' (Id: 64f5531f-0a4c-4bac-addf-2e1b59ab4e4d) to exclude AppId 76cb8750-843f-42e1-976c-1cd4e9d79069...
2025-06-11 15:55:10 [INFO] Policy '901 - Privileged Access (New)' updated to exclude AppId 76cb8750-843f-42e1-976c-1cd4e9d79069.
2025-06-11 15:55:10 [WARN] Skipping Microsoft-managed policy 'Microsoft-managed: Multifactor authentication and reauthentication for risky sign-ins'; cannot update excluded apps.
2025-06-11 15:55:11 [INFO] Updating policy 'Priv - Restrict Access to cPAW only' (Id: 1152d395-1fa4-4412-8699-32053bdea41f) to exclude AppId 76cb8750-843f-42e1-976c-1cd4e9d79069...
2025-06-11 15:55:12 [INFO] Policy 'Priv - Restrict Access to cPAW only' updated to exclude AppId 76cb8750-843f-42e1-976c-1cd4e9d79069.
2025-06-11 15:55:12 [INFO] Script completed. Please verify CA exclusions and grant admin consent for [Storage Account] vpawstorage.file.core.windows.net in Azure Portal.
2025-06-11 15:55:12 [INFO] Conditional Access exclusion complete.
